<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
    <link rel="icon" href="/docs/4.0/assets/img/favicons/favicon.ico">

    <title>Learning Homepage</title>

    <!-- Bootstrap CSS -->
    <link href="../assets/bootstrap.min.css" rel="stylesheet">

    <!-- Page css -->
    <link href="./css/global.css" rel="stylesheet"> 
    <link href="./css/learning.css" rel="stylesheet"> 
    <link href="./css/interactive.css" rel="stylesheet"> 
    
    <!-- Konva must be imported before page loaded -->
    <script src="../assets/konva.min.js"></script>


  </head>

  <body>

    <nav class="navbar navbar-expand-md fixed-top border-bottom border-light navbar-light" id="nav">
      <a class="navbar-brand" href="index.html">
        <img src="./img/bootstrap-solid.svg" width="60" height="60" class="d-inline-block align-middle" alt="">
        Home
      </a>

  
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        
        <ul class="navbar-nav mr-auto">
          <li class="nav-item active">
            <a class="nav-link" href="Learning3.html">Learning<span class="sr-only">(current)</span></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">UML Builder</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="http://example.com" id="dropdown01" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Resources</a>
            <div class="dropdown-menu" aria-labelledby="dropdown01">
              <a class="dropdown-item" href="#">Action</a>
              <a class="dropdown-item" href="#">Another action</a>
              <a class="dropdown-item" href="#">Something else here</a>
            </div>
          </li>
        </ul>
        
      
        <ul class="navbar-nav navbar-right">
          <li class="nav-item"><a class="nav-link" href="#"><span class="fas fa-sign-in-alt"></span> Login</a></li>
          <li class="nav-item"><a class="nav-link" href="#"> <span class="fas fa-user"></span> Sign Up</a> </li>


     
        </ul>

        <form class="form-inline my-2 my-lg-1">
          <input class="form-control mr-sm-2" type="text" placeholder="Search..." aria-label="Search">
          <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
        </form>
      </div>


    </nav>

    <div class="container-fluid">
      <div class="row">
        <nav class="col-md-3 col-lg-2 d-none d-md-block bg-light sidebar border-top " id ="sidebar">
          <div class="sidebar-sticky">
            <ul class="nav flex-column">
              <li class="nav-item">
                <a class="nav-link active" href="#">
                  <span data-feather="home"></span>
                  Learning Home <span class="sr-only">(current)</span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#">
                  <span data-feather="file"></span>
                  Introduction
                </a>
              </li>

              
            </ul>

            <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
              <span >Chapter 1: Shapes</span>
              <a class="d-flex align-items-center text-muted" href="#">
                <span data-feather="plus-circle"></span>
              </a>
            </h6>


            <ul class="nav flex-column mb-2">
              <li class="nav-item">
                <a class="nav-link" href="#">
                  <span data-feather="file-text"></span>
                  Squares
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#">
                  <span data-feather="file-text"></span>
                  Classes
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#">
                  <span data-feather="file-text"></span>
                  Inheritance
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#">
                  <span data-feather="file-text"></span>
                  Structure not behaviour
                </a>
              </li>
            </ul>

            <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
              <span>Chapter 2: Relationships</span>
              <a class="d-flex align-items-center text-muted" href="#">
                <span data-feather="plus-circle"></span>
              </a>
            </h6>

            <ul class="nav flex-column mb-2">
              <li class="nav-item">
                <a class="nav-link" href="#">
                  <span data-feather="file-text"></span>
                  Aggregation
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#">
                  <span data-feather="file-text"></span>
                  Dependency
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#">
                  <span data-feather="file-text"></span>
                  Composition
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#">
                  <span data-feather="file-text"></span>
                  Styles
                </a>
              </li>
            </ul>

            
          </div>

          


        </nav>

        <main role="main" class=" col-md-9 ml-sm-auto col-lg-10 pt-3 col-12" style="padding-right: 0;" >

          
          <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
            <h1 class="h2">Squares</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
              <div class="btn-group mr-2">
                <button class="btn btn-sm btn-outline-secondary">Share</button>
                <button class="btn btn-sm btn-outline-secondary">Export</button>
              </div>
              <button class="btn btn-sm btn-outline-secondary dropdown-toggle">
                <span data-feather="calendar"></span>
                This week
              </button>
            </div>
          </div>

          <div class="d-flex align-items-center mb-3"><strong style="margin-right: 20px;" >Tasks</strong><button class="taskButton" style=""> </button> <button class="taskButton" style=""> </button> <button class="taskButton" style=""> </button> <button class="taskButton" style=""> </button> <button class="taskButton" style=""> </button> <button class="taskButton" style=""> </button> <button class="taskButton" style=""> </button> </div>

          <div class="jumbotron text-start" style="padding:20px">
            Morbi nec tortor vulputate, fringilla turpis quis, ultricies lorem. Cras at mi blandit nisi pharetra venenatis dignissim non risus. Ut faucibus eros eget massa pellentesque dignissim. Mauris euismod vel elit vel faucibus. Sed augue nisl, feugiat in faucibus quis, sollicitudin id orci. Fusce volutpat, turpis id aliquet mollis, augue orci sagittis erat, id fermentum arcu enim sed neque. Nulla porttitor sem sit amet ipsum consequat, nec auctor sapien feugiat. Aliquam leo eros, luctus dictum lectus at, placerat aliquet nulla.
          </div>
          
          <!-- example -->
          <div class="container-fluid">
            <div class="row">

              <div class="col" style="background-color: #a9c8ee; border: 3px solid #637d9c; border-radius: 20px; color:black; ">
                <p><strong style="font-size: 30px;">Example</strong></p>
                <P>Here you see three classes, try and connect them together with the relationship lines and give them a name!</P>

                <div class = "d-flex justify-content-between pl-3 pr-3" style="background-color: whitesmoke; border-radius: 20px 20px 0 0; color:rgb(71, 71, 71)">
                  
                  <h1>Title</h1>
                  <span class="mr-auto align-self-center ml-2" data-feather="edit"></span>

                  
                  <div class="headerIcons FUCK align-self-center mr-2" > <!-- just to place some constraints -->
                    <i data-feather="save" alt="Container"></i>
                  </div>
                  
                  <h5 class="align-self-center mr-4 FUCK">Save</h5>
                  <div class="headerIcons align-self-center mr-1" > <!-- just to place some constraints -->
                    <i data-feather="folder" alt="Container"></i>
                  </div>
                  <h5 class="align-self-center mr-3">Load</h5>
                </div>


                
                <div class = "border" style= "min-height: 500px; overflow: hidden; background-color: whitesmoke;" id="container"></div>


                <div class = "d-flex pl-3 pr-3 flex-wrap flex-sm-row flex-column " style="background-color: whitesmoke; border-radius: 0 0 20px 20px; overflow-x:hidden; overflow-y:visible">

                  <p style="font-size: 2em;" class="mr-3">Entities </p> 
                  <p style="font-size: 2em;" class="mr-auto">Relationships</p>
                  <br>
                  <div class="headerIcons mr-1" > <!-- just to place some constraints -->
                    <i data-feather="share" alt="Container"></i>
                  </div>
                  <p class=" mr-3" style="font-size: 1em;"> Share</p>
                <script>

                

                  // Setup canvas 
                  var width = document.getElementById("container").offsetWidth;
                  var height = document.getElementById("container").offsetHeight;
                  var mobile = false;

                  var umlClasses = [];
                  var umlRelationships = [];
            
                  var stage = new Konva.Stage({
                    container: 'container',
                    width: width,
                    height: height,
                  });
            
                  var layer = new Konva.Layer();
                  var rectX = stage.width() / 2 - 50;
                  var rectY = stage.height() / 2 - 25;
          

                  function renderClass(umlRawClass) {

                    var umlClass = umlRawClass.classObj
                    
                    // Render widths
                    var width;
                    

                    // Render class header
                    umlClass.headerText.width(umlClass.header.width());
                    umlClass.header.height(umlClass.headerText.height());


                    // Render class methods
                    umlClass.methods.y(umlClass.header.height());
                    umlClass.methodText.y(umlClass.methods.y())
                    umlClass.methodText.width(umlClass.methods.width())
                    umlClass.methods.height(umlClass.methodText.height())
                    

                    umlClass.attributes.y(umlClass.methods.y() + umlClass.methods.height())
                    umlClass.attributeText.y(umlClass.attributes.y())
                    umlClass.attributeText.width(umlClass.attributes.width())
                    umlClass.attributes.height(umlClass.attributeText.height())

                    // Render excess height
                    
                  }



                    var tr = new Konva.Transformer();
                    layer.add(tr);
                    tr.nodes([]);

                    stage.add(layer);
                  
                   var selectionRectangle = new Konva.Rect({
                    fill: 'rgba(0,0,255,0.5)',
                    visible: false,
                  });
                  layer.add(selectionRectangle);

                  var x1, y1, x2, y2;
                  stage.on('mousedown touchstart', (e) => {
                    console.log(e.target)
                    if (e.target.hasName("anchor") || e.target.attrs.relationship == true) {
                      return;
                    }
                    hideAllAnchors()
                    // do nothing if we mousedown on any shape
                    if (e.target !== stage) {
                      return;
                    }
                    e.evt.preventDefault();
                    x1 = stage.getPointerPosition().x;
                    y1 = stage.getPointerPosition().y;
                    x2 = stage.getPointerPosition().x;
                    y2 = stage.getPointerPosition().y;

                    selectionRectangle.visible(true);
                    selectionRectangle.width(0);
                    selectionRectangle.height(0);
                  });

                  stage.on('mousemove touchmove', (e) => {
                    // do nothing if we didn't start selection
                    if (!selectionRectangle.visible()) {
                      return;
                    }
                    e.evt.preventDefault();
                    x2 = stage.getPointerPosition().x;
                    y2 = stage.getPointerPosition().y;

                    selectionRectangle.setAttrs({
                      x: Math.min(x1, x2),
                      y: Math.min(y1, y2),
                      width: Math.abs(x2 - x1),
                      height: Math.abs(y2 - y1),
                    });
                  });

                  stage.on('mouseup touchend', (e) => {
                    // do nothing if we didn't start selection
                    if (!selectionRectangle.visible()) {
                      return;
                    }
                    e.evt.preventDefault();
                    // update visibility in timeout, so we can check it in click event
                    setTimeout(() => {
                      selectionRectangle.visible(false);
                    });

                    var shapes = stage.find('.rect');
                    var box = selectionRectangle.getClientRect();
                    var selected = shapes.filter((shape) =>
                      Konva.Util.haveIntersection(box, shape.getClientRect())
                    );
                    tr.nodes(selected);
                  });

                  // clicks should select/deselect shapes
                  stage.on('click tap', function (e) {
                    // if we are selecting with rect, do nothing
                    if (selectionRectangle.visible()) {
                      return;
                    }

                    // if click on empty area - remove all selections
                    if (e.target === stage) {
                      tr.nodes([]);
                      return;
                    }

                    // Check if the UmlClass was clicked, else do nothing
                    if (e.target.hasName('umlChild')) {
                      console.log(e.target)
                      e.target = e.target.parent
                    } {
                      if (!e.target.hasName('rect')) {
                      
                      return;
                    }

                    }
   

                    // do we pressed shift or ctrl?
                    const metaPressed = e.evt.shiftKey || e.evt.ctrlKey || e.evt.metaKey;
                    const isSelected = tr.nodes().indexOf(e.target) >= 0;

                    if (!metaPressed && !isSelected) {
                      // if no key pressed and the node is not selected
                      // select just one
                      tr.nodes([e.target]);
                    } else if (metaPressed && isSelected) {
                      // if we pressed keys and node was selected
                      // we need to remove it from selection:
                      const nodes = tr.nodes().slice(); // use slice to have new copy of array
                      // remove node from array
                      nodes.splice(nodes.indexOf(e.target), 1);
                      tr.nodes(nodes);
                    } else if (metaPressed && !isSelected) {
                      // add the node into selection
                      const nodes = tr.nodes().concat([e.target]);
                      tr.nodes(nodes);
                    }
                  });


                   editField = (e) => {
                      // create textarea over canvas with absolute position

        // first we need to find position for textarea
        // how to find it?

        // at first lets find position of text node relative to the stage:
        var textPosition = e.target.getAbsolutePosition();

// then lets find position of stage container on the page:
var stageBox = stage.container().getBoundingClientRect();

// so position of textarea will be the sum of positions above:
var areaPosition = {
  x: stageBox.left + textPosition.x,
  y: stageBox.top + textPosition.y,
};

// create textarea and style it
var textarea = document.createElement('textarea');
document.body.appendChild(textarea);

textarea.value = e.target.text();
if (!e.target.attrs.isHeader) {
  e.target.align('left')
}

textarea.style.position = 'absolute';
textarea.style.top = areaPosition.y + 'px';
textarea.style.left = areaPosition.x + 'px';
textarea.style.width = e.target.width();

var targetField = e.target

textarea.focus();

textarea.addEventListener('keydown', function (e) {
  // hide on enter
  if (e.keyCode === 13) {
    targetField.text(textarea.value);
    document.body.removeChild(textarea);
    renderClass(targetField.parent)
  }
});
}
                    

                function genArrow() {
                  var arrow = new Konva.Arrow({
                            x: stage.width() / 4,
                            y: stage.height() / 4,
                            points: [0, 0, 100, 0],
                            pointerLength: 20,
                            pointerWidth: 20,
                            fill: 'black',
                            stroke: 'black',
                            strokeWidth: 4,
                            name:"rect",
                            draggable:true,
                          });
                                      
                        layer.add(arrow)
                        return arrow
                }

                //genArrow()
                //genArrow()





                function genClass(headerColor) {

                  if (typeof headerColor === 'undefined') { headerColor = 'white'; }
                  var umlClass = new Konva.Group({
                        x: 10, 
                        y: 10, 
                        width: 130,
                        height: 25,
                        name: 'rect',
                        draggable: true,
                        stroke: 'black',
                        strokeWidth: 4,
                        
                    }); 

                  var umlHeader = new Konva.Rect({
                        width: 130,
                        height: 25,
                        fill: headerColor,
                        name: 'umlChild',
                        cornerRadius:[10,10,0,0],
                        stroke: 'black',
                        strokeWidth: 2,
                    });

                  var umlMethods = new Konva.Rect({
                      width: 130,
                      height: 25,
                      fill: '#FAFAFA',
                      y:25,
                      name: 'umlChild',
                      stroke: 'black',
                        strokeWidth: 2,
                  });
                  
                  var umlAttributes = new Konva.Rect({
                      width: 130,
                      height: 25,
                      fill: '#F2F2F2',
                      y:25,
                      name: 'umlChild',
                      cornerRadius:[0,0,10,10],
                      stroke: 'black',
                        strokeWidth: 2,
                  });

                  var umlHeaderText = new Konva.Text({
                        text:'UML Class',
                        fontSize: 18,
                        fontFamily: 'Calibri',
                        fill: '#000',
                        width: 130,
                        padding: 5,
                        align: 'center',
                        name: 'umlChild',
                        isHeader:true,
                    });

                    var umlMethodText = new Konva.Text({
                        text:'UML Methods',
                        fontSize: 18,
                        fontFamily: 'Calibri',
                        fill: '#000',
                        width: 130,
                        padding: 5,
                        align: 'center',
                        name: 'umlChild',
                        isHeader:false,

                    });

                    var umlAttributeText = new Konva.Text({
                        text:'UML Attributes',
                        fontSize: 18,
                        fontFamily: 'Calibri',
                        fill: '#000',
                        width: 130,
                        padding: 5,
                        align: 'center',
                        name: 'umlChild',
                        isHeader:false
                    });

                  umlHeaderText.on('dblclick dbltap', (e) => editField(e))
                  umlAttributeText.on('dblclick dbltap', (e) => editField(e))
                  umlMethodText.on('dblclick dbltap', (e) => editField(e))

                  umlClass.add(umlHeader)
                  umlClass.add(umlHeaderText)
                  umlClass.add(umlMethods)
                  umlClass.add(umlMethodText)
                  umlClass.add(umlAttributes)
                  umlClass.add(umlAttributeText)

                  var classObj = {
                    class:umlClass,
                    header:umlHeader,
                    headerText:umlHeaderText,
                    methods:umlMethods,
                    methodText:umlMethodText,
                    attributes:umlAttributes,
                    attributeText:umlAttributeText
                  }

                  umlClass.classObj = classObj
                  
                  renderClass(umlClass)
                  layer.add(umlClass)
                  return umlClass;
                  
                  
                }
                
                var a = genClass()
                var b = genClass()
                genClass()


                function genRelationship() {

                
                  var quadLinePath = new Konva.Line({
                  dash: [10, 10, 0, 10],
                  strokeWidth: 3,
                  stroke: 'black',
                  lineCap: 'round',
                  id: 'quadLinePath',
                  opacity: 0.3,
                  points: [0, 0],
                });
                layer.add(quadLinePath);

                var quad = {
                start: buildAnchor(60, 30),
                control: buildAnchor(240, 110),
                end: buildAnchor(80, 160),
              };
                
              var quadraticLine = new Konva.Arrow({
                stroke: 'black',
                
                strokeWidth: 4,
                sceneFunc: (ctx, shape) => {
                  ctx.beginPath();
                  ctx.moveTo(quad.start.x(), quad.start.y());
                  ctx.quadraticCurveTo(
                    quad.control.x(),
                    quad.control.y(),
                    quad.end.x(),
                    quad.end.y()
                  );
                  ctx.fillStrokeShape(shape);
                },
              });
             


              var umlRelationship = new Konva.Group({
                    name: 'rect',
                    draggable: true,
                    relationship: true,

                }); 

              umlRelationship.add(quadraticLine);


              function buildAnchor(x, y) {
                var anchor = new Konva.Circle({
                  x: x,
                  name:"anchor",
                  y: y,
                  radius: 20,
                  stroke: '#666',
                  fill: '#ddd',
                  strokeWidth: 2,
                  draggable: true,
                });

                anchor.visible(false)
                

                // add hover styling
                anchor.on('mouseover', function () {
                  document.body.style.cursor = 'pointer';
                  this.strokeWidth(4);
                  //anchor.show()
                  //this.show()
                });

                
                anchor.on('mouseout', function () {
                  document.body.style.cursor = 'default';
                  anchor.hide()
                  //this.hide()
                  this.strokeWidth(2);
                });

                //anchor.on('dragmove', function () {
                //  updateDottedLines();
                //});
                

                return anchor;
              }
              umlRelationship.attrs.anchors = quad
              umlRelationship.add(umlRelationship.attrs.anchors.start)
              umlRelationship.add(umlRelationship.attrs.anchors.control)
              umlRelationship.add(umlRelationship.attrs.anchors.end)
              umlRelationship.on('mouseover', function () {
                  quad.start.show()
                  quad.control.show()
                  quad.end.show()
                });

                umlRelationship.on('tap click', function() {
                  quad.start.show()
                  quad.control.show()
                  quad.end.show()
                });


                umlRelationship.on('mouseout', function() {
                  quad.start.hide()
                  quad.control.hide()
                  quad.end.hide()
                });

                umlRelationships.push(umlRelationship)
                layer.add(umlRelationship)
                }

                genRelationship()
                genRelationship()


                function hideAllAnchors() {
                  for (relationship in umlRelationships) {
                    console.log(umlRelationships[relationship])
                    umlRelationships[relationship].attrs.anchors.start.visible(false)
                    umlRelationships[relationship].attrs.anchors.control.visible(false)
                    umlRelationships[relationship].attrs.anchors.end.visible(false)
                  }
                }

                hideAllAnchors()








 //layer.add(quadraticLine);

       
                   
                </script>


              </div>

            </div>


          </div>
          <!-- END example-->

        </main>
      </div>
    </div>

    <!-- Javascript imports -->    
    <script src="../assets/jquery-3.2.1.slim.min.js">window.jQuery</script>
    <script src="../assets/popper.min.js"></script>
    <script src="../assets/bootstrap.min.js"></script>

    

    <!-- Enable library functionality -->
    <script>
      $(function () {
      $('[data-toggle="popover"]').popover()
    })
  </script>
   <!-- Icons -->
   <script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
   <script>
     feather.replace()
   </script>

  </body>
</html>
